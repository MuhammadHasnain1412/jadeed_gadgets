{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Shopping Cart - Jadeed Gadgets{% endblock %}

{% block extra_css %}
<style>
    body {
        font-family: 'Roboto', Arial, sans-serif;
        color: #333;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
    }
    
    .container {
        border-radius: 15px;
        padding: 30px;
        margin-top: -50px;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
    }
    
    .cart-header {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        text-align: center;
    }
    
    .cart-header h4 {
        margin: 0;
        font-weight: 300;
        font-size: 24px;
    }
    
    .table-header {
        display: grid;
        grid-template-columns: 3fr 1fr 1fr 1fr 0.5fr;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        font-weight: 600;
        color: #495057;
        text-transform: uppercase;
        font-size: 12px;
        letter-spacing: 1px;
    }
    
    .header-item {
        text-align: center;
    }
    
    .header-item:first-child {
        text-align: left;
    }
    
    .cart-table {
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
    }
    
    .cart-item {
        display: grid;
        grid-template-columns: 3fr 1fr 1fr 1fr 0.5fr;
        align-items: center;
        padding: 20px 15px;
        border-bottom: 1px solid #eee;
        transition: all 0.3s ease;
    }
    
    .cart-item:last-child {
        border-bottom: none;
    }
    
    .cart-item:hover {
        {% comment %} background: linear-gradient(90deg, #f8f9fa 0%, #e9ecef 100%); {% endcomment %}
        transform: translateX(5px);
    }
    
    .product-info {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .product-image {
        width: 70px;
        height: 70px;
        border-radius: 8px;
        overflow: hidden;
        background: #f8f9fa;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .product-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .placeholder-img {
        color: #adb5bd;
        font-size: 24px;
    }
    
    .product-details {
        flex: 1;
    }
    
    .product-name {
        font-size: 16px;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 5px;
        line-height: 1.3;
    }
    
    .product-brand {
        color: #6c757d;
        font-size: 14px;
        margin-bottom: 3px;
    }
    
    .product-stock {
        color: #28a745;
        font-size: 12px;
        font-weight: 500;
    }
    
    .price-info, .total-info {
        text-align: center;
    }
    
    .price-text, .item-total {
        font-size: 16px;
        font-weight: 700;
        color: #e74c3c;
    }
    
    .quantity-info {
        display: flex;
        justify-content: center;
    }
    
    .quantity-controls {
        display: flex;
        align-items: center;
        background: #f8f9fa;
        border-radius: 25px;
        padding: 5px;
        gap: 5px;
    }
    
    .quantity-btn {
        width: 32px;
        height: 32px;
        border: none;
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        font-size: 12px;
    }
    
    .quantity-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    .quantity-input {
        width: 50px;
        height: 32px;
        border: none;
        background: transparent;
        text-align: center;
        font-weight: 600;
        color: #2c3e50;
        outline: none;
    }
    
    .remove-info {
        text-align: center;
    }
    
    .remove-btn {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: #dc3545;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        transition: all 0.2s ease;
    }
    
    .remove-btn:hover {
        background: #c82333;
        transform: scale(1.1);
        text-decoration: none;
        color: white;
        box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
    }
    
    .cart-summary {
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }
    
    .cart-summary .card-header {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 20px;
    }
    
    .cart-summary .btn-success {
        background: linear-gradient(45deg, #28a745, #20c997);
        border: none;
        border-radius: 25px;
        padding: 12px 24px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        transition: all 0.3s ease;
    }
    
    .cart-summary .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
    }
    
    @media (max-width: 768px) {
        .table-header {
            display: none;
        }
        
        .cart-item {
            grid-template-columns: 1fr;
            gap: 15px;
            text-align: center;
        }
        
        .product-info {
            flex-direction: column;
            text-align: center;
        }
    }
    
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    {% csrf_token %}
    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}" id="csrf-token">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-shopping-cart"></i> Shopping Cart</h2>
                <div>
                    <span class="badge badge-primary">{{ total_items }} item{{ total_items|pluralize }}</span>
                    <a href="/" class="btn btn-outline-primary ml-2">
                        <i class="fas fa-arrow-left"></i> Continue Shopping
                    </a>
                </div>
            </div>
        </div>
    </div>

    {% if cart_items %}
        <div class="row">
            <!-- Cart Items -->
            <div class="col-lg-8">
                <div class="cart-header">
                    <h4><i class="fas fa-shopping-basket"></i> Your Items ({{ total_items }})</h4>
                </div>
                <div class="cart-table">
                    <div class="table-header">
                        <div class="header-item">Product</div>
                        <div class="header-item">Price</div>
                        <div class="header-item">Quantity</div>
                        <div class="header-item">Total</div>
                        <div class="header-item">Remove</div>
                    </div>
                    {% for item in cart_items %}
                    <div class="cart-item" data-item-id="{{ item.id }}">
                        <div class="product-info">
                            <div class="product-image">
                                {% if item.product.image %}
                                    <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}">
                                {% else %}
                                    <div class="placeholder-img">
                                        <i class="fas fa-image"></i>
                                    </div>
                                {% endif %}
                            </div>
                            <div class="product-details">
                                <div class="product-name">{{ item.product.name }}</div>
                                <div class="product-brand">{{ item.product.brand }}</div>
                                <div class="product-stock">In Stock: {{ item.product.stock }}</div>
                            </div>
                        </div>
                        <div class="price-info">
                            <div class="price-text">Rs. {{ item.product.price|floatformat:0|intcomma }}</div>
                        </div>
                        <div class="quantity-info">
                            <div class="quantity-controls">
                                <button class="quantity-btn" onclick="changeQuantity({{ item.id }}, -1)">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <input type="number" class="quantity-input" 
                                       value="{{ item.quantity }}" min="1" max="{{ item.product.stock }}"
                                       onchange="updateQuantity({{ item.id }}, this.value)">
                                <button class="quantity-btn" onclick="changeQuantity({{ item.id }}, 1)">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="total-info">
                            <div class="item-total">Rs. {{ item.total_price|floatformat:0|intcomma }}</div>
                        </div>
                        <div class="remove-info">
                            <a href="{% url 'remove_from_cart' item.id %}" class="remove-btn" 
                               onclick="return confirm('Remove this item from cart?')">
                                <i class="fas fa-times"></i>
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Cart Actions -->
                <div class="mt-3">
                    <a href="{% url 'clear_cart' %}" class="btn btn-outline-warning" 
                       onclick="return confirm('Clear entire cart?')">
                        <i class="fas fa-trash-alt"></i> Clear Cart
                    </a>
                    <a href="{% url 'wishlist' %}" class="btn btn-outline-info ml-2">
                        <i class="fas fa-heart"></i> View Wishlist
                    </a>
                </div>
            </div>

            <!-- Cart Summary -->
            <div class="col-lg-4">
                <div class="card cart-summary">
                    <div class="card-header">
                        <h5 class="mb-0">Order Summary</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Items ({{ total_items }}):</span>
                            <span id="cart-total">Rs. {{ total_price|floatformat:2|intcomma }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Shipping:</span>
                            <span class="text-success">Free</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between mb-3">
                            <strong>Total:</strong>
                            <strong id="final-total" class="text-success">Rs. {{ total_price|floatformat:2|intcomma }}</strong>
                        </div>
                        
                        <a href="{% url 'checkout' %}" class="btn btn-success btn-block mb-2">
                            <i class="fas fa-credit-card"></i> Proceed to Checkout
                        </a>
                        
                        <small class="text-muted">
                            <i class="fas fa-shield-alt"></i> Secure checkout with SSL encryption
                        </small>
                    </div>
                </div>

                <!-- Suggested Actions -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h6 class="mb-0">Quick Actions</h6>
                    </div>
                    <div class="card-body">
                        <a href="/" class="btn btn-outline-primary btn-sm btn-block mb-2">
                            <i class="fas fa-plus"></i> Add More Items
                        </a>
                        <a href="{% url 'wishlist' %}" class="btn btn-outline-secondary btn-sm btn-block">
                            <i class="fas fa-heart"></i> View Wishlist
                        </a>
                    </div>
                </div>
            </div>
        </div>

    {% else %}
        <!-- Empty Cart -->
        <div class="row">
            <div class="col-12">
                <div class="text-center py-5">
                    <i class="fas fa-shopping-cart fa-5x text-muted mb-4"></i>
                    <h3 class="text-muted">Your cart is empty</h3>
                    <p class="text-muted mb-4">Add some products to get started!</p>
                    <a href="/" class="btn btn-primary">
                        <i class="fas fa-shopping-bag"></i> Start Shopping
                    </a>
                    <a href="{% url 'wishlist' %}" class="btn btn-outline-secondary ml-2">
                        <i class="fas fa-heart"></i> View Wishlist
                    </a>
                </div>
            </div>
        </div>
    {% endif %}
</div>

<script>
function changeQuantity(itemId, change) {
    const quantityInput = document.querySelector(`[data-item-id="${itemId}"] .quantity-input`);
    const currentQuantity = parseInt(quantityInput.value);
    const newQuantity = currentQuantity + change;
    
    updateQuantity(itemId, newQuantity);
}

function updateQuantity(itemId, newQuantity) {
    // Convert to integer
    newQuantity = parseInt(newQuantity);
    
    if (isNaN(newQuantity) || newQuantity < 1) {
        if (confirm('Remove this item from cart?')) {
            window.location.href = `/accounts/cart/remove/${itemId}/`;
        }
        return;
    }
    
    // Show loading state
    const quantityInput = document.querySelector(`[data-item-id="${itemId}"] .quantity-input`);
    const originalValue = quantityInput.value;
    quantityInput.disabled = true;
    
    fetch(`/accounts/cart/update/${itemId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken(),
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({ quantity: newQuantity })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Update item total
            document.querySelector(`[data-item-id="${itemId}"] .item-total`).textContent = `Rs. ${data.item_total.toFixed(0)}`;
            // Update cart total
            document.getElementById('cart-total').textContent = `Rs. ${data.cart_total.toFixed(0)}`;
            document.getElementById('final-total').textContent = `Rs. ${data.cart_total.toFixed(0)}`;
            // Update quantity input
            quantityInput.value = newQuantity;
            
            // Update cart count in navigation
            const cartBadge = document.querySelector('.cart-badge');
            if (cartBadge) {
                if (data.cart_items_count > 0) {
                    cartBadge.textContent = data.cart_items_count;
                    cartBadge.style.display = 'flex';
                } else {
                    cartBadge.style.display = 'none';
                }
            }
        } else {
            showErrorToast(data.message);
            // Reset to original value
            quantityInput.value = originalValue;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showErrorToast('An error occurred. Please try again.');
        // Reset to original value
        quantityInput.value = originalValue;
    })
    .finally(() => {
        quantityInput.disabled = false;
    });
}


function getCSRFToken() {
    // First try to get from hidden input (most reliable)
    const hiddenInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
    if (hiddenInput) {
        return hiddenInput.value;
    }
    
    // Then try to get from cookie
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, 'csrftoken'.length + 1) === ('csrftoken' + '=')) {
                cookieValue = decodeURIComponent(cookie.substring('csrftoken'.length + 1));
                break;
            }
        }
    }
    
    return cookieValue;
}
</script>
{% endblock %}
